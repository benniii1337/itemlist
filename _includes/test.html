{%- assign Fabrics = '' | split: ',' -%}
{%- assign Leathers = '' | split: ',' -%}
{%- assign Metals = '' | split: ',' -%}
{%- assign Stone = '' | split: ',' -%}

{%- for item in site.data.StoreItems.items -%}
  {%- if item.category == "Textiles" -%}
    {%- assign Fabrics = Fabrics | push: item | sort: "abr" -%}
    {%- continue -%}
  {%- endif -%}
  
  {%- if item.category == "Wools" -%}
    {%- assign Fabrics = Fabrics | push: item | sort: "abr" -%}
    {%- continue -%}
  {%- endif -%}
  
  {%- if item.category == "Leathers" -%}
    {%- assign Leathers = Leathers | push: item | sort: "abr" -%}
    {%- continue -%}
  {%- endif -%}
  
  {%- if item.category == "Stone blocks" -%}
    {%- assign Stone = Stone | push: item | sort: "abr" -%}
    {%- continue -%}
  {%- endif -%}
  
  {%- if item.category == "Raw resources" -%}
    {%- if item.abr == "wood" -%}
      {%- continue -%}
    {%- elsif item.abr == "jade" -%}
      {%- assign Stone = Stone | push: item | sort: "abr" -%}
      {%- continue -%}
    {% else %}
      {%- assign Metals = Metals | push: item | sort: "abr" -%}
      {%- continue -%}
    {%- endif -%}
  {%- endif -%}  
{%- endfor -%}

{%- assign techNeolithic = '' | split: ',' -%}
{%- assign techMedieval = '' | split: ',' -%}
{%- assign techIndustrial = '' | split: ',' -%}
{%- assign techSpacer = '' | split: ',' -%}
{%- assign techUltratech = '' | split: ',' -%}
{%- assign techArchotech = '' | split: ',' -%}

{%- for item in include.displayData  -%}
  {%- if item.tech == "Neolithic" -%}
    {%- assign techNeolithic = techNeolithic | push: item | sort: "abr" -%}
    {%- continue -%}
  {%- endif -%}
  
  {%- if item.tech == "Medieval" -%}
    {%- assign techMedieval = techMedieval | push: item | sort: "abr" -%}
    {%- continue -%}
  {%- endif -%}
  
  {%- if item.tech == "Industrial" -%}
    {%- assign techIndustrial = techIndustrial | push: item | sort: "abr" -%}
    {%- continue -%}
  {%- endif -%}
  
  {%- if item.tech == "Spacer" -%}
    {%- assign techSpacer = techSpacer | push: item | sort: "abr" -%}
    {%- continue -%}
  {%- endif -%}
  
  {%- if item.tech == "Ultratech" -%}
    {%- assign techUltratech = techUltratech | push: item | sort: "abr" -%}
    {%- continue -%}
  {%- endif -%}
  
  {%- if item.tech == "Archotech" -%}
    {%- assign techArchotech = techArchotech | push: item | sort: "abr" -%}
    {%- continue -%}
  {%- endif -%}
{%- endfor -%}

<div class="box">
  <div class="drops">
    <select id="select_item" style="width: 100%">
      <option value="" data-placeholder>{{- include.type -}}</option>
      <optgroup id="neolithic" label="Neolithic">
        {%- for item in techNeolithic -%}
          <option data-cat="{{- item.ingredients -}}" value="{{- item.abr -}}">{{- item.abr | capitalize -}}</option>
          {%- continue -%}
        {%- endfor -%}
      </optgroup>
      <optgroup id="medieval" label="Medieval">
        {%- for item in techMedieval -%}
          <option data-cat="{{- item.ingredients -}}" value="{{- item.abr -}}">{{- item.abr | capitalize -}}</option>
          {%- continue -%}
        {%- endfor -%}
      </optgroup>
      <optgroup id="industrial" label="Industrial">
        {%- for item in techIndustrial -%}
          <option data-cat="{{- item.ingredients -}}" value="{{- item.abr -}}">{{- item.abr | capitalize -}}</option>
          {%- continue -%}
        {%- endfor -%}
      </optgroup>
      <optgroup id="spacer" label="Spacer">
        {%- for item in techSpacer -%}
          <option data-cat="{{- item.ingredients -}}" value="{{- item.abr -}}">{{- item.abr | capitalize -}}</option>
          {%- continue -%}
        {%- endfor -%}
      </optgroup>
      <optgroup id="ultratech" label="Ultratech">
        {%- for item in techUltratech -%}
          <option data-cat="{{- item.ingredients -}}" value="{{- item.abr -}}">{{- item.abr | capitalize -}}</option>
          {%- continue -%}
        {%- endfor -%}
      </optgroup>
      <optgroup id="archotech" label="Archotech">
        {%- for item in techArchotech -%}
          <option data-cat="{{- item.ingredients -}}" value="{{- item.abr -}}">{{- item.abr | capitalize -}}</option>
          {%- continue -%}
        {%- endfor -%}
      </optgroup>
    </select>
  </div>
  <div class="drops">
    <select id="select_material" style="width: 100%">
      <option value="" data-placeholder>Material</option>
      <optgroup id="fabric" label="Fabrics">
        {%- for item in Fabrics -%}
          <option value="{{- item.abr -}}">{{- item.abr | capitalize -}}</option>
          {%- continue -%}
        {%- endfor -%}
      </optgroup>
      <optgroup id="leathery" label="Leathers">
        {%- for item in Leathers -%}
          <option value="{{- item.abr -}}">{{- item.abr | capitalize -}}</option>
          {%- continue -%}
        {%- endfor -%}
      </optgroup>
      <optgroup id="stony" label="Stone">
        {%- for item in Stone -%}
          <option value="{{- item.abr -}}">{{- item.abr | capitalize -}}</option>
          {%- continue -%}
        {%- endfor -%}
      </optgroup>
      <optgroup id="metallic" label="Metals">
        {%- for item in Metals -%}
          <option value="{{- item.abr -}}">{{- item.abr | capitalize -}}</option>
          {%- continue -%}
        {%- endfor -%}
      </optgroup>
      <optgroup id="woody" label="Wood">
          <option value="wood">Wood</option>
      </optgroup>
    </select>
  </div>
  <div class="drops">
    <select id="select_quality" style="width: 100%">
      <option value="" data-placeholder>Quality</option>
      <option value="awful">Awful</option>
      <option value="poor">Poor</option>
      <option value="normal">Normal</option>
      <option value="good">Good</option>
      <option value="excellent">Excellent</option>
      <option value="masterwork">Masterwork</option>
      <option value="legendary">Legendary</option>
    </select>
  </div>
</div>
<div class="ei-box">
  <input id="cmdout" class="ei-out" type="text" placeholder="Chatcommand" onclick="this.select()" readonly>
  <span class="focus-border"></span>
</div>
<div class="copy">
  <button class="ei-btn" onclick="copyOutput()">COPY</button>
  <button class="ei-btn" onclick="toggleCmd()">SWITCH</button>
  <button class="ei-btn" onclick="clearDrops()">CLEAR</button>    
</div>

<script>

  easydropdown('#select_item', {
    behavior: {
      liveUpdates: true,
      showPlaceholderWhenOpen: true
    },
    callbacks: {
      onSelect: function() {
        var val = $('#select_item').find(':selected').data('cat');
        val = val.split(", ");
        val = val.map(function(elem) { return elem.toLowerCase(); }); 
        var srch = document.getElementById('{{- include.id -}}Input');
        clearDrops();
        srch.value = $('#select_item').find(':selected').val();
        srch.onkeyup();
        if (val == "") {
          $('#select_material').attr("disabled", "disabled");
        } else {
          $('#select_material').removeAttr("disabled");
          document.querySelectorAll("#select_material optgroup").forEach(opt => {
            if ($.inArray(opt.id, val) != -1) {
              opt.disabled = false; 
            } else {
              opt.disabled = true;
            }
          });
        }
        showCommand();
      },
    }
  });
  
  easydropdown('#select_material', {
    behavior: {
      liveUpdates: true,
      showPlaceholderWhenOpen: true
    },
    callbacks: {
      onSelect: function() {
        showCommand();
      },
    }
  });
  
  easydropdown('#select_quality', {
    behavior: {
      liveUpdates: true,
      showPlaceholderWhenOpen: true
    },
    callbacks: {
      onSelect: function() {
        showCommand();
      },
    }
  });
  
  function clearDrops() {
    $("#select_material")[0].selectedIndex = 0;
    $("#select_quality")[0].selectedIndex = 0;
  }
  
  var cmd = "$wear ";

  function toggleCmd() {
    if (!cmd || cmd == "$wear ") {
      cmd = "$"
    } else {
      cmd = "$wear "
    };
    showCommand();
  }
  
  function showCommand() {
    var part1 = document.getElementById('select_item').value;
    var part2 = document.getElementById('select_material').value;
    var part3 = document.getElementById('select_quality').value;
       
    if (part1) {
      if (!part2 && !part3) {
        result = cmd + part1;
      } else if (!part2 || !part3) {
        result = cmd + part1.concat("[", part2, part3, "]");
      } else {
        result = cmd + part1.concat("[", part2, ",", part3, "]");
      };
      document.getElementById('cmdout').value = result
    };
  };
  
  function copyOutput() {
    var copyText = document.getElementById("cmdout");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);
  };
  
</script>
